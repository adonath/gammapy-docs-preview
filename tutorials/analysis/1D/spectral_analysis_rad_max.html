
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spectral analysis with energy-dependent directional cuts &#8212; gammapy v0.20.dev703+gba08bf709</title>
    
    <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gammapy.css" />
    
    <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../../_static/gammapy_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Ring background map" href="../2D/ring_background.html" />
    <link rel="prev" title="Tutorials" href="../../index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../../index.html">
  <img src="../../../_static/gammapy_logo_nav.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting-started/index.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../../../userguide/index.html">
  User guide
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../../index.html">
  Tutorials
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../api.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../development/index.html">
  Development
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../changelog/index.html">
  Release notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        dev  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables tutorials/analysis/1D/spectral_analysis_rad_max and {'json_url': 'https://docs.gammapy.org/stable/switcher.json', 'url_template': 'https://docs.gammapy.org/{version}/', 'version_match': 'dev'}.
-->

<script type="text/javascript">
// Construct the target URL from the JSON components
function buildURL(entry) {
    var template = "https://docs.gammapy.org/{version}/";  // supplied by jinja
    template = template.replace("{version}", entry.version);
    return template;
}

// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "tutorials/analysis/1D/spectral_analysis_rad_max.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://docs.gammapy.org/stable/switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "tutorials/analysis/1D/spectral_analysis_rad_max.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            // get the base URL for that doc version, add the current page's
            // path to it, and set as `href`
            entry.url = buildURL(entry);
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.20.dev703+gba08bf709 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "dev") {
                node.classList.add("active");
                $("#version_switcher_button").text(entry.name);
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/gammapy/gammapy" rel="noopener" target="_blank" title="Github"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">Github</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/gammapyST" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://gammapy.slack.com/" rel="noopener" target="_blank" title="Slack"><span><i class="fab fa-slack"></i></span>
            <label class="sr-only">Slack</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../userguide/analysis.html">
   Gamma-ray data analysis
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../userguide/package.html">
   Package structure
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/dl3.html">
     Data access and selection (DL3)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/makers.html">
     Data reduction (DL3 to DL4)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/dl4.html">
     Datasets (DL4)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/modeling.html">
     Modeling and Fitting (DL4 to DL5)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/hli.html">
     High Level Analysis Interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/catalog.html">
     Source catalogs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/astro.html">
     Astrophysics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/stats.html">
     Statistical utility functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/cli.html">
     Command line tools
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/visualization.html">
     Plotting features
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../userguide/utils.html">
     Utility functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../index.html">
   Tutorials
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../../starting/analysis_1.html">
     High level interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../starting/analysis_2.html">
     Low level API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../starting/overview.html">
     Data structures
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data/cta.html">
     CTA with Gammapy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data/hess.html">
     H.E.S.S. with Gammapy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data/fermi_lat.html">
     Fermi-LAT with Gammapy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spectral_analysis.html">
     Spectral analysis
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Spectral analysis with energy-dependent directional cuts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sed_fitting.html">
     Flux point fitting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="extended_source_spectral_analysis.html">
     Spectral analysis of extended sources
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="spectrum_simulation.html">
     1D spectrum simulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="cta_sensitivity.html">
     Point source sensitivity
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../2D/ring_background.html">
     Ring background map
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../2D/modeling_2D.html">
     2D map fitting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../2D/detect.html">
     Source detection and significance maps
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3D/cta_data_analysis.html">
     Basic image exploration and fitting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3D/analysis_3d.html">
     3D detailed analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3D/simulate_3d.html">
     3D map simulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3D/analysis_mwl.html">
     Multi instrument joint 3D and 1D analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3D/event_sampling.html">
     Event sampling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../3D/flux_profiles.html">
     Flux Profile Estimation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../time/light_curve_simulation.html">
     Simulating and fitting a time varying source
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../time/light_curve.html">
     Light curves
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../time/light_curve_flare.html">
     Light curves for flares
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../time/pulsar_analysis.html">
     Pulsar analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/makers.html">
     Makers - Data reduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/catalog.html">
     Source catalogs
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/models.html">
     Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/model_management.html">
     Modelling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/fitting.html">
     Fitting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/maps.html">
     Maps
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/mask_maps.html">
     Mask maps
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/astro_dark_matter.html">
     Dark matter spatial and spectral models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/datasets.html">
     Datasets - Reduced data, IRFs, models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../survey_map.html">
     Survey map
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../userguide/howto.html">
   How To
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../modeling/gallery/index.html">
   Model gallery
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spatial/plot_constant.html">
     Constant spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spatial/plot_disk.html">
     Disk spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spatial/plot_gauss.html">
     Gaussian spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spatial/plot_gen_gauss.html">
     Generalized gaussian spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spatial/plot_point.html">
     Point spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spatial/plot_shell.html">
     Shell spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spatial/plot_shell2.html">
     Shell2 spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spatial/plot_template.html">
     Template spatial model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_absorbed.html">
     EBL absorbption spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_broken_powerlaw.html">
     Broken power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_compound.html">
     Compound spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_constant_spectral.html">
     Constant spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_exp_cutoff_powerlaw.html">
     Exponential cutoff power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_exp_cutoff_powerlaw_3fgl.html">
     Exponential cutoff power law spectral model used for 3FGL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_gauss_spectral.html">
     Gaussian spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_logparabola.html">
     Log parabola spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_naima.html">
     Naima spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_piecewise_norm_spectral.html">
     Piecewise  norm spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_powerlaw.html">
     Power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_powerlaw2.html">
     Power law 2 spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_smooth_broken_powerlaw.html">
     Smooth broken power law spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_super_exp_cutoff_powerlaw_3fgl.html">
     Super exponential cutoff power law model used for 3FGL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_super_exp_cutoff_powerlaw_4fgl.html">
     Super Exponential Cutoff Power Law Model used for 4FGL-DR3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_super_exp_cutoff_powerlaw_4fgl_dr1.html">
     Super Exponential Cutoff Power Law Model used for 4FGL-DR1 (and DR2)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/spectral/plot_template_spectral.html">
     Template spectral model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/temporal/plot_constant_temporal.html">
     Constant temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/temporal/plot_expdecay_temporal.html">
     ExpDecay temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/temporal/plot_gaussian_temporal.html">
     Gaussian temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/temporal/plot_generalized_gaussian_temporal.html">
     Generalized Gaussian temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/temporal/plot_linear_temporal.html">
     Linear temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/temporal/plot_powerlaw_temporal.html">
     PowerLaw temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/temporal/plot_sine_temporal.html">
     Sine temporal model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../modeling/gallery/temporal/plot_template_temporal.html">
     Light curve temporal model
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://gammapy.github.io/gammapy-recipes">
   Gammapy recipes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../userguide/references.html">
   Glossary and references
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Prerequisites">
   Prerequisites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Context">
   Context
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Define-the-ON-region">
   Define the ON region
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Run-data-reduction-chain">
   Run data reduction chain
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-spectrum">
   Fit spectrum
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Fit-quality-and-model-residuals">
   Fit quality and model residuals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Compare-against-the-literature">
   Compare against the literature
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Spectral-analysis-with-energy-dependent-directional-cuts">
<h1>Spectral analysis with energy-dependent directional cuts<a class="headerlink" href="#Spectral-analysis-with-energy-dependent-directional-cuts" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Prerequisites">
<h2>Prerequisites<a class="headerlink" href="#Prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Understanding the basic data reduction performed in a <a class="reference internal" href="spectral_analysis.html"><span class="doc">1D analysis</span></a>;</p></li>
<li><p>understanding the difference between a <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/irfs/point_like/index.html">point-like</a> and a <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/irfs/full_enclosure/index.html">full-enclosure</a> IRF.</p></li>
</ul>
</div>
<div class="section" id="Context">
<h2>Context<a class="headerlink" href="#Context" title="Permalink to this headline">¶</a></h2>
<p>As already explained in these tutorials, in a <a class="reference internal" href="spectral_analysis.html"><span class="doc">1D spectral analysis</span></a> the background is estimated from the field of view of the observation. In particular, the source and background events are counted within a circular ON region enclosing the source. The background to be subtracted is then estimated from one or more OFF regions with an expected background rate similar to the one in the ON region (i.e. from regions with similar acceptance).</p>
<p><em>Full-containment</em> IRFs have no directional cut applied, when employed for a 1D analysis, it is required to apply a correction to the IRF accounting for flux leaking out of the ON region. This correction is typically obtained by integrating the PSF within the ON region.</p>
<p>When computing a <em>point-like</em> IRFs, a directional cut around the assumed source position is applied to the simulated events. For this IRF type, no PSF component is provided. The size of the ON and OFF regions used for the spectrum extraction should then reflect this cut, since a response computed within a specific region around the source is being provided.</p>
<p>The directional cut is typically an angular distance from the assumed source position, <span class="math notranslate nohighlight">\(\theta\)</span>. The <a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/">gamma-astro-data-format</a> specifications offer two different ways to store this information: * if the same <span class="math notranslate nohighlight">\(\theta\)</span> cut is applied at all energies and offsets, <cite>a ``RAD_MAX`</cite> keyword &lt;<a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/irfs/point_like/#rad-max">https://gamma-astro-data-formats.readthedocs.io/en/latest/irfs/point_like/#rad-max</a>&gt;`__ is added to the header of the data units containing
IRF components. This should be used to define the size of the ON and OFF regions; * in case an energy- (and offset-) dependent <span class="math notranslate nohighlight">\(\theta\)</span> cut is applied, its values are stored in additional <code class="docutils literal notranslate"><span class="pre">FITS</span></code> data unit, named <code class="docutils literal notranslate"><span class="pre">`RAD_MAX_2D</span></code> &lt;<a class="reference external" href="https://gamma-astro-data-formats.readthedocs.io/en/latest/irfs/point_like/#rad-max-2d">https://gamma-astro-data-formats.readthedocs.io/en/latest/irfs/point_like/#rad-max-2d</a>&gt;`__.</p>
<p><code class="docutils literal notranslate"><span class="pre">Gammapy</span></code> provides a class to automatically read this values, <code class="docutils literal notranslate"><span class="pre">~gammapy.irf.RadMax2D</span></code>, for both cases (fixed or energy-dependent <span class="math notranslate nohighlight">\(\theta\)</span> cut). In this notebook we will focus on how to perform a spectral extraction with a point-like IRF with an energy-dependent <span class="math notranslate nohighlight">\(\theta\)</span> cut. We remark that in this case a <code class="docutils literal notranslate"><span class="pre">~regions.PointSkyRegion</span></code> (and not a <code class="docutils literal notranslate"><span class="pre">~regions.CircleSkyRegion</span></code>) should be used to define the ON region. If a geometry based on a <code class="docutils literal notranslate"><span class="pre">~regions.PointSkyRegion</span></code> is fed to the
spectra and the background <code class="docutils literal notranslate"><span class="pre">Makers</span></code>, the latter will automatically use the values stored in the <code class="docutils literal notranslate"><span class="pre">RAD_MAX</span></code> keyword / table for defining the size of the ON and OFF regions.</p>
<p>Beside the definition of the ON region during the data reduction, the remaining steps are identical to the other <a class="reference internal" href="spectral_analysis.html"><span class="doc">1D spectral analysis example</span></a>, so we will not detail the data reduction steps already presented in the other tutorial.</p>
<p><strong>Objective: perform the data reduction and analysis of 2 Crab Nebula observations of MAGIC and fit the resulting datasets.</strong></p>
</div>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<p>We load two MAGIC observations in the <a class="reference external" href="https://github.com/gammapy/gammapy-data">gammapy-data</a> containing IRF component with a <span class="math notranslate nohighlight">\(\theta\)</span> cut.</p>
<p>We define the ON region, this time as a <code class="docutils literal notranslate"><span class="pre">PointSkyRegion</span></code> instead of a <code class="docutils literal notranslate"><span class="pre">CircleSkyRegion</span></code>, i.e. we specify only the center of our ON region. We create a <code class="docutils literal notranslate"><span class="pre">RegionGeom</span></code> adding to the region the estimated energy axis of the <code class="docutils literal notranslate"><span class="pre">~gammapy.datasets.SpectrumDataset</span></code> object we want to produce. The corresponding dataset maker will automatically use the <span class="math notranslate nohighlight">\(\theta\)</span> values in <code class="docutils literal notranslate"><span class="pre">~gammapy.irf.RadMax2D</span></code> to set the appropriate ON region sizes (based on the offset on the observation and on the estimated
energy binning).</p>
<p>In order to define the OFF regions it is recommended to use a <code class="docutils literal notranslate"><span class="pre">~gammapy.makers.WobbleRegionsFinder</span></code>, that uses fixed positions for the OFF regions. In the different estimated energy bins we will have OFF regions centered at the same positions, but with changing size. As for the <code class="docutils literal notranslate"><span class="pre">SpectrumDataSetMaker</span></code>, the <code class="docutils literal notranslate"><span class="pre">BackgroundMaker</span></code> will use the values in <code class="docutils literal notranslate"><span class="pre">~gammapy.irf.RadMax2D</span></code> to define the sizes of the OFF regions.</p>
<p>Once the datasets with the ON and OFF counts are created, we can perform a 1D likelihood fit, exactly as illustrated in the previous example.</p>
</div>
<div class="section" id="Setup">
<h2>Setup<a class="headerlink" href="#Setup" title="Permalink to this headline">¶</a></h2>
<p>As usual, we’ll start with some setup …</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check package versions</span>
<span class="kn">import</span> <span class="nn">gammapy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">regions</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gammapy:&quot;</span><span class="p">,</span> <span class="n">gammapy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;numpy:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;astropy&quot;</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="n">regions</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">PointSkyRegion</span>
<span class="kn">from</span> <span class="nn">gammapy.data</span> <span class="kn">import</span> <span class="n">DataStore</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">MapAxis</span><span class="p">,</span> <span class="n">RegionGeom</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling</span> <span class="kn">import</span> <span class="n">Fit</span>
<span class="kn">from</span> <span class="nn">gammapy.datasets</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Datasets</span><span class="p">,</span>
    <span class="n">SpectrumDataset</span><span class="p">,</span>
    <span class="n">SpectrumDatasetOnOff</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_crab_spectral_model</span><span class="p">,</span>
    <span class="n">SkyModel</span><span class="p">,</span>
    <span class="n">LogParabolaSpectralModel</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.makers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SpectrumDatasetMaker</span><span class="p">,</span>
    <span class="n">WobbleRegionsFinder</span><span class="p">,</span>
    <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">,</span>
    <span class="n">SafeMaskMaker</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">gammapy.utils.scripts</span> <span class="kn">import</span> <span class="n">make_path</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Load-data">
<h2>Load data<a class="headerlink" href="#Load-data" title="Permalink to this headline">¶</a></h2>
<p>We load the two MAGIC observations of the Crab Nebula containing the <code class="docutils literal notranslate"><span class="pre">RAD_MAX_2D</span></code> table.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_store</span> <span class="o">=</span> <span class="n">DataStore</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="s2">&quot;$GAMMAPY_DATA/magic/rad_max/data&quot;</span><span class="p">)</span>
<span class="n">observations</span> <span class="o">=</span> <span class="n">data_store</span><span class="o">.</span><span class="n">get_observations</span><span class="p">(</span><span class="n">required_irf</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aeff&quot;</span><span class="p">,</span> <span class="s2">&quot;edisp&quot;</span><span class="p">,</span> <span class="s2">&quot;rad_max&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">RadMax2D</span></code> attribute, containing the <code class="docutils literal notranslate"><span class="pre">RAD_MAX_2D</span></code> table, is automatically loaded in the observation. As we can see from the IRF component axes, the table has a single offset value and 28 estimated energy values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rad_max</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Define-the-ON-region">
<h2>Define the ON region<a class="headerlink" href="#Define-the-ON-region" title="Permalink to this headline">¶</a></h2>
<p>To use the <code class="docutils literal notranslate"><span class="pre">RAD_MAX_2D</span></code> values to define the sizes of the ON and OFF regions <strong>it is necessary to specify the ON region as a</strong><code class="docutils literal notranslate"><span class="pre">`PointSkyRegion</span></code> &lt;<a class="reference external" href="https://astropy-regions.readthedocs.io/en/stable/api/regions.PointSkyRegion.html">https://astropy-regions.readthedocs.io/en/stable/api/regions.PointSkyRegion.html</a>&gt;`__<strong>.</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_position</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mf">83.63</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mf">22.01</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>
<span class="n">on_region</span> <span class="o">=</span> <span class="n">PointSkyRegion</span><span class="p">(</span><span class="n">target_position</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Run-data-reduction-chain">
<h2>Run data reduction chain<a class="headerlink" href="#Run-data-reduction-chain" title="Permalink to this headline">¶</a></h2>
<p>We begin with the configuration of the dataset maker classes:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># true and estimated energy axes</span>
<span class="n">energy_axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
    <span class="mi">10</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;GeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span>
<span class="p">)</span>
<span class="n">energy_axis_true</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span>
    <span class="mi">10</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;GeV&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy_true&quot;</span>
<span class="p">)</span>

<span class="c1"># geometry defining the ON region and SpectrumDataset based on it</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">RegionGeom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">on_region</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">energy_axis</span><span class="p">])</span>

<span class="n">dataset_empty</span> <span class="o">=</span> <span class="n">SpectrumDataset</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">geom</span><span class="o">=</span><span class="n">geom</span><span class="p">,</span> <span class="n">energy_axis_true</span><span class="o">=</span><span class="n">energy_axis_true</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SpectrumDataset</span></code> is now based on a geometry consisting of a single coordinate and an estimated energy axis. The <code class="docutils literal notranslate"><span class="pre">SpectrumDatasetMaker</span></code> and <code class="docutils literal notranslate"><span class="pre">ReflectedRegionsBackgroundMaker</span></code> will take care of producing ON and OFF with the proper sizes, automatically adopting the <span class="math notranslate nohighlight">\(\theta\)</span> values in <code class="docutils literal notranslate"><span class="pre">Observation.rad_max</span></code>.</p>
<p>As explained in the introduction, we use a <code class="docutils literal notranslate"><span class="pre">WobbleRegionsFinder</span></code>, to determine the OFF positions. The parameter <code class="docutils literal notranslate"><span class="pre">n_off_positions</span></code> specifies the number of OFF regions to be considered.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_maker</span> <span class="o">=</span> <span class="n">SpectrumDatasetMaker</span><span class="p">(</span>
    <span class="n">containment_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;exposure&quot;</span><span class="p">,</span> <span class="s2">&quot;edisp&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># tell the background maker to use the WobbleRegionsFinder, let us use 1 off</span>
<span class="n">region_finder</span> <span class="o">=</span> <span class="n">WobbleRegionsFinder</span><span class="p">(</span><span class="n">n_off_regions</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">bkg_maker</span> <span class="o">=</span> <span class="n">ReflectedRegionsBackgroundMaker</span><span class="p">(</span><span class="n">region_finder</span><span class="o">=</span><span class="n">region_finder</span><span class="p">)</span>

<span class="c1"># use the energy threshold specified in the DL3 files</span>
<span class="n">safe_mask_masker</span> <span class="o">=</span> <span class="n">SafeMaskMaker</span><span class="p">(</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aeff-default&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">()</span>

<span class="k">for</span> <span class="n">observation</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">dataset_empty</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">observation</span><span class="o">.</span><span class="n">obs_id</span><span class="p">)),</span> <span class="n">observation</span>
    <span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">bkg_maker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">dataset_on_off</span> <span class="o">=</span> <span class="n">safe_mask_masker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
    <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataset_on_off</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Fit-spectrum">
<h2>Fit spectrum<a class="headerlink" href="#Fit-spectrum" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">We perform a joint likelihood fit of the two datasets.</div>
<div class="line">For this particular datasets we select a fit range between <span class="math notranslate nohighlight">\(80\,{\rm GeV}\)</span> and <span class="math notranslate nohighlight">\(20\,{\rm TeV}\)</span>.</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">e_min</span> <span class="o">=</span> <span class="mi">80</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span>
<span class="n">e_max</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">mask_fit</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">energy_mask</span><span class="p">(</span><span class="n">e_min</span><span class="p">,</span> <span class="n">e_max</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectral_model</span> <span class="o">=</span> <span class="n">LogParabolaSpectralModel</span><span class="p">(</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="mf">1e-12</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;cm-2 s-1 TeV-1&quot;</span><span class="p">),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">reference</span><span class="o">=</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span><span class="n">spectral_model</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;crab&quot;</span><span class="p">)</span>

<span class="n">datasets</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>

<span class="n">fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>

<span class="c1"># we make a copy here to compare it later</span>
<span class="n">best_fit_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Fit-quality-and-model-residuals">
<h2>Fit quality and model residuals<a class="headerlink" href="#Fit-quality-and-model-residuals" title="Permalink to this headline">¶</a></h2>
<p>We can access the results dictionary to see if the fit converged:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>and check the best-fit parameters</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datasets</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">to_parameters_table</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>A simple way to inspect the model residuals is using the function <code class="docutils literal notranslate"><span class="pre">~SpectrumDataset.plot_fit()</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax_spectrum</span><span class="p">,</span> <span class="n">ax_residuals</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">()</span>
<span class="n">ax_spectrum</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>For more ways of assessing fit quality, please refer to the dedicated <a class="reference internal" href="../2D/modeling_2D.html"><span class="doc">modeling and fitting tutorial</span></a>.</p>
</div>
<div class="section" id="Compare-against-the-literature">
<h2>Compare against the literature<a class="headerlink" href="#Compare-against-the-literature" title="Permalink to this headline">¶</a></h2>
<p>Let us compare the spectrum we obtained against a <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2015JHEAp...5...30A/abstract">previous measurement by MAGIC</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s2">&quot;energy_bounds&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.08</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
   <span class="s2">&quot;sed_type&quot;</span><span class="p">:</span> <span class="s2">&quot;e2dnde&quot;</span><span class="p">,</span>
   <span class="s2">&quot;yunits&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;TeV cm-2 s-1&quot;</span><span class="p">),</span>
   <span class="s2">&quot;xunits&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">crab_magic_lp</span> <span class="o">=</span> <span class="n">create_crab_spectral_model</span><span class="p">(</span><span class="s1">&#39;magic_lp&#39;</span><span class="p">)</span>

<span class="n">best_fit_model</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;best fit&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
<span class="n">best_fit_model</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot_error</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
<span class="n">crab_magic_lp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MAGIC reference&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">1e-13</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../../index.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Tutorials</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../2D/ring_background.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Ring background map</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2022, The Gammapy developers.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>